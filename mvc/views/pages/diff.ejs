<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="../../../static/icons/leaf_logo.svg">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
          integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
          integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
          crossorigin="anonymous">
    <link rel="stylesheet" href="../../../static/css/common.css">
    <link rel="stylesheet" href="../../../static/css/colors.css">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
            integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
            crossorigin="anonymous"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.1/fabric.min.js"></script>
    <script src="lib/baselineView.js"></script>
    <script src="lib/gridHelpers.js"></script>
    <script src="lib/diffHelpers.js"></script>
    <script src="../../../static/js/bootstrap-toolkit.js"></script>
    <script src="../lib/commonEvents.js"></script>

    <title>Shapshoot - <%= expected_snapshoot.name; %> | <%= expected_snapshoot.id; %>
        | <%= expected_snapshoot.formattedcreatedDate; %></title>
</head>
<body style="overflow-x: auto">
<div class="container-fluid pl-3 pr-1" style="    height:100vh !important; background-color: #E5E5E5 !important;">
    <div name="page-head" class="row bg-olive text-light ">
        <div name="logo-and-link"
             class="col-auto pr-0"
             id="logo-and-label-container"
             style="width: 90px !important"
        >
            <div class="row">
                <div class="col-auto ml-4 pl-0 pr-0 pt-1 no-highlight toggle-sidebar-button-wrapper vcenter">
                    <%- include('components/sidebar_switcher') %>
                </div>
                <div name="logo-img" class="col-auto pl-1 pr-0 pt-1">
                    <%- include('components/logo') %>
                </div>
            </div>
        </div>

        <div name="title"
             class="col pl-4 pt-0 h6 mb-0 d-flex align-items-center text-truncate"
             title="<%= suite.name; %>/<%= test.name; %>/<%= (check.name.replace(/_/g, ' ')); %> [<%= check.status[0] %>]"
        >
            <a class="diff-back-button back-button unlink small" href="javascript:void(0)"
               onclick="backToTest('<%= test.id %>')">
                <img src="../../../static/icons/back-button.svg" alt="navigation button" class="navigation-button">
            </a>
            &nbsp;
            <a class="unlink" name="suite-link"
               href="/?filter_suitename_eq=<%= suite.name %>"><%= suite.name %></a>
            <span>/</span>
            <a class="unlink" name="check-link"
               href='/?filter_suitename_eq=<%= suite.name %>&unfoldTestId=<%= test.id %>'><%= test.name %></a>
            <span>/</span>
            <%= (check.name.replace(/_/g, ' ')); %> [<%= check.status[0] %>]
        </div>

        <div name="dropdown-menu" class="col-auto align-self-end pl-4 pt-0 h4 mb-0 light-purple">
            <div class="d-flex flex-row pb-1 pt-1 dropdown dropdown-item1 pl-2 pr-2 pb-1" data-toggle="dropdown">

                <div class="bg-<%= check.status[0] %> ml-2 mt-2 ml-1 mb-0" style="width: 20px; height: 20px"></div>
                <div class="dropdown1 mb-1">
                    <button class="btn mr-1 bg-olive text-light dropdown-toggle btn-sm" type="button"
                            id="dropdownMenuButton" aria-haspopup="true" aria-expanded="false"
                            style="box-shadow: none"
                    >
                        <%= check.viewport %> <%= check.os %>
                    </button>
                    <div class="dropdown-menu text-left" aria-labelledby="dropdownMenu">

                        <% for (const ch of lastChecksWithSameName) { %>
                            <!-- "ch.actualSnapshotId || ch.baselineId" is to stub new case -->
                            <% const url = `?diffid=${ch.diffId || ''}&actualid=${ch.actualSnapshotId || ch.baselineId}&expectedid=${ch.baselineId}&checkid=${ch.id}` %>
                            <div class="d-flex flex-row pb-1 pt-1 dropdown-item pl-2 pr-2">
                                <div class="bg-<%= ch.status[0] %> ml-2 mb-0" style="width: 20px"></div>
                                <div>
                                    <% const decoration = (ch.id === check.id) ? 'underline' : 'none' %>
                                    <a class="dropdown-item small pl-2 pr-2"
                                       onclick="document.location.href = '<%= url %>'"
                                       href=#
                                       style="text-decoration: <%= decoration %>"> <%= ch.viewport %> <%= ch.os %> </a>
                                </div>
                            </div>

                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div name="all-content" class="row pl-1" style="background-color: #E5E5E5 !important;">
        <div name="sidebar" id='sidebar' class="col-1 pl-4 pr-4 ml-0 mt-3 mh-100">
            <%- include('components/diff_sidebar') %>
        </div>
        <div name="shapshoot" id='snapshoot' class="col-10 pl-0 pr-0 mt-2 mh-100 ml-2 m-1">

            <div class="toolbar-wrapper sticky-top float-right pt-0 pr-4">
                <div class="diff-toolbar shadow vcenter border border-secondary rounded mt-1 pr-0 row d-flex align-content-center bg-light"
                     style="height: 33px; line-height: 30px;"
                >
                    <%- include('components/diff_toolbar') %>
                </div>
            </div>
            <div class="canvas-wrapper shadow mr-0">
                <canvas class="snapshoot-canvas" id="2d">
                </canvas>
            </div>
        </div>
    </div>
</div>

<!--NOTIFY BOX-->
<div id="notify" role="alert" aria-live="assertive" aria-atomic="true"
     class="fixed-bottom-right bg-light m-1 border rounded toast fade show"
     data-autohide="false"
     style="display: none"
>
    <div class="toast-header border-bottom">
        <svg class="bd-placeholder-img rounded mr-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg"
             preserveAspectRatio="xMidYMid slice" focusable="false" role="img">
            <rect id="notify-rect" width="100%" height="100%" fill="#2ECC40"></rect>
        </svg>
        <strong id="notify-header" class="mr-auto">Success</strong>
        <!--        <small>11 mins ago</small>-->
        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close"
                onclick="$('#notify').hide()">
            <span aria-hidden="true">Ã—</span>
        </button>
    </div>
    <div id="notify-message" class="toast-body">
        Operation was successful finished
    </div>
</div>
<script>
    fabric.Object.prototype.objectCaching = false;
    var canvas = new fabric.Canvas('2d');
    var expectedImg = {};
    var actualImg = {};
    var diffImg = {};
    var baseline = {};
    // canvas.setHeight(document.getElementById('snapshoot').offsetHeight);
    canvas.setWidth(document.getElementById('snapshoot').offsetWidth);

    <% if(actual_snapshoot) { %>
    canvas.hoverCursor = 'col-resize';
    <% } %>
    <!--console.log('/snapshoots/<%= expected_snapshoot.filename ? expected_snapshoot.filename : expected_snapshoot.id + '.png' %>')-->
    fabric.Image.fromURL('/snapshoots/<%= expected_snapshoot.filename ? expected_snapshoot.filename : expected_snapshoot.id + '.png' %>',
        function (oImg) {
            window.BaselineImg = oImg;
            canvas.add(oImg);
            expectedImg = oImg;
            oImg.moveTo(0);
            oImg.scaleToWidth(canvas.width);
            canvas.setHeight(oImg.getScaledHeight());
            <% if(actual_snapshoot) { %>
            oImg.clipPath = clipPath;

            // console.log(`<%= actual_snapshoot.filename %>`);
            console.log(`/snapshoots/<%= actual_snapshoot.filename ? actual_snapshoot.filename : actual_snapshoot.id + '.png' %>`);
            fabric.Image.fromURL(`/snapshoots/<%= actual_snapshoot.filename ? actual_snapshoot.filename : actual_snapshoot.id + '.png' %>`, function (oImg) {
                canvas.add(oImg);
                window.expectedImg = oImg;
                actualImg = oImg;
                oImg.moveTo(0);
                oImg.scaleToWidth(canvas.width);
                canvas.renderAll();
            });
            <% } %>
        });

    fabric.Image.fromURL('/snapshoots/<%= diff_snapshoot.filename ? diff_snapshoot.filename : diff_snapshoot.id + '.png' %>', function (oImg) {
        oImg.set('opacity', 0);
        canvas.add(oImg);
        diffImg = oImg;
        oImg.moveTo(4);
        oImg.scaleToWidth(canvas.width);
        canvas.renderAll();
    });

    var clipPath = new fabric.Rect({
        width: canvas.width,
        height: canvas.height,
        top: 0,
        left: 0,
        absolutePositioned: true,
        opacity: 0.01,
        // fill: 'green',
        fill: 'rgba(0,0,0,0)',
        strokeWidth: 2,
        stroke: 'rgba(100,200,200,0.5)',
        lockMovementX: true,
        lockMovementY: true
    });
    var clipPathWrapper = new fabric.Rect({
        width: 1,
        height: canvas.height,
        top: -4,
        left: -4,
        absolutePositioned: true,
        opacity: 0.1,
        // fill: 'rgba(0,0,0,0)',
        fill: 'Aquamarine',
        strokeWidth: 3,
        stroke: 'rgba(100,200,200,0.8)',
        lockMovementX: true,
        lockMovementY: true,
    });

    canvas.add(clipPath);
    canvas.add(clipPathWrapper);
    clipPath.moveTo(3);
    clipPath.scaleToWidth(canvas.width);

    clipPath.originX = 'left';

    function toggleReqions() {
        if (baseline.allRects && (baseline.allRects.length > 0)) {
            console.log('DESTROY');
            baseline.destroy();
        } else {
            baseline = new BaselineView('2d',
                expectedImg,
                {
                    canvas: canvas,
                    noAddImage: true
                }
            );
            baseline.getSnapshotIgnoreRegionsDataAndDrawRegions('<%= expected_snapshoot.id %>');
        }
    }

    function resizeSnapshoot(ratio) {
        let w = expectedImg.getScaledWidth();
        expectedImg.scaleToWidth(w * ratio);
        if (Object.keys(actualImg).length > 0) {
            actualImg.scaleToWidth(w * ratio);
        }
        if (Object.keys(diffImg).length > 0) {
            diffImg.scaleToWidth(w * ratio);
        }
        canvas.renderAll();
    }

    function toggleDiffOpacity() {
        if (diffImg.opacity === 1) {
            diffImg.opacity = 0;
            canvas.hoverCursor = 'col-resize';
        } else {
            diffImg.opacity = 1;
            canvas.hoverCursor = 'auto';
        }

        canvas.renderAll();
    }

    <% if(actual_snapshoot) { %>

    canvas.on('mouse:move', function (event) {
        let ofsetX = parseInt(event.pointer.x);
        clipPath.width = ofsetX;
        clipPathWrapper.width = ofsetX + 2;
        clipPath.height = actualImg.getScaledHeight();
        clipPathWrapper.height = actualImg.getScaledHeight() + 2;
        canvas.renderAll();
    });

    canvas.on('mouse:up:before', function (event) {
        toggleDiffOpacity();
    });
    <% } %>
</script>
</body>
</html>
